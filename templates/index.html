{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 text-center">
        <h1 class="display-4 mb-4">Welcome to Language Learner</h1>
        <p class="lead">Start your language learning journey today with our interactive platform.</p>
    </div>
</div>

{% if current_user.is_authenticated %}
    <div class="row mt-5">
        <div class="col-md-4">
            <div class="card h-100 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Vocabulary Practice</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Practice new vocabulary words every day to build your language skills.</p>
                    <a href="{{ url_for('daily_practice') }}" class="btn btn-primary">Start Vocabulary Practice</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">Chat Practice</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Practice conversations with our AI language tutor to improve fluency.</p>
                    <a href="{{ url_for('chat') }}" class="btn btn-success">Start Chatting</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Speaking Practice</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Complete interactive speaking exercises to enhance your pronunciation.</p>
                    <a href="{{ url_for('exercises') }}" class="btn btn-info">Start Speaking</a>
                </div>
            </div>
        </div>
    </div>
{% else %}
    <div class="row mt-5">
        <div class="col-md-6 mx-auto text-center">
            <div class="card">
                <div class="card-body">
                    <h2>Get Started</h2>
                    <p class="lead">Create an account to begin your language learning journey.</p>
                    <a href="{{ url_for('register') }}" class="btn btn-primary btn-lg">Sign Up Now</a>
                </div>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-vocab-btn');
    if (generateBtn) {
        generateBtn.addEventListener('click', async function() {
            try {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';

                const response = await fetch('/api/generate-vocabulary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to generate vocabulary');
                }

                // Reload the page to show new vocabulary
                window.location.reload();
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate vocabulary. Please try again.');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'Generate New Words';
            }
        });
    }
});

async function playAudio(button, text, lang) {
    try {
        button.disabled = true;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i>';

        // Detect language if not provided
        if (!lang) {
            const hasSpanish = /[áéíóúñ¿¡]/i.test(text) || /hola|gracias|por favor/i.test(text);
            const hasItalian = /[àèéìíòóùú]/i.test(text) || /ciao|grazie|prego/i.test(text);
            
            lang = 'en'; // Default to English
            if (hasSpanish) {
                lang = 'es'; // Spanish
            } else if (hasItalian) {
                lang = 'it'; // Italian
            }
        }

        // We'll let the server select the appropriate voice based on language
        const ttsSettings = {
            speed: 0.8,         // Slightly slower for better comprehension
            model: 'tts-1-hd'   // Higher quality audio
        };

        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        const response = await fetch('/api/text-to-speech', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                text: text,
                lang: lang,
                speed: ttsSettings.speed,
                model: ttsSettings.model
            }),
        });

        if (!response.ok) {
            throw new Error('Failed to generate audio');
        }

        const data = await response.json();
        console.log(`Playing audio in ${lang} with voice "${data.voice}"`);
        const audio = new Audio(data.audio_url);

        audio.onended = () => {
            button.innerHTML = originalHTML;
            button.disabled = false;
        };

        audio.onerror = () => {
            console.error('Audio playback failed');
            button.innerHTML = originalHTML;
            button.disabled = false;
        };

        await audio.play();
    } catch (error) {
        console.error('TTS error:', error);
        button.innerHTML = '<i class="bi bi-volume-up"></i>';
        button.disabled = false;
    }
}
</script>
{% endblock %}